// Gundam Card Game Database Schema
// This schema defines the data models for the Gundam Card Game website

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// User model for authentication and user management
model User {
  id                     String    @id @default(cuid())
  email                  String    @unique
  password               String?   // For credentials auth
  name                   String?
  image                  String?
  role                   UserRole  @default(USER)
  emailVerified          DateTime? // For NextAuth
  passwordResetToken     String?   // Password reset token
  passwordResetExpires   DateTime? // Password reset token expiration
  emailVerificationToken String?   // Email verification token
  emailVerificationExpires DateTime? // Email verification token expiration
  createdAt              DateTime  @default(now())
  updatedAt              DateTime  @updatedAt

  // NextAuth relations
  accounts Account[]
  sessions Session[]

  // Application relations
  decks               Deck[]
  deckVersions        DeckVersion[]
  collections         Collection[]
  submissions         CardSubmission[]
  reviewedSubmissions CardSubmission[] @relation("ReviewedSubmissions")
  favoriteDecks       UserFavoriteDeck[]
  templateUsage       DeckTemplateUsage[]

  @@map("users")
}

// NextAuth Account model
model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

// NextAuth Session model
model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

// NextAuth Verification Token model
model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

// User roles enum
enum UserRole {
  USER
  ADMIN
  MODERATOR
}

// Card type model - Based on official Gundam Card Game rules
model CardType {
  id          String @id @default(cuid())
  name        String @unique
  description String?
  category    String? // "Unit", "Character", "Command", "Operation", "Generation"

  // Relations
  cards Card[]

  @@map("card_types")
}

// Rarity model
model Rarity {
  id          String @id @default(cuid())
  name        String @unique
  color       String
  description String?

  // Relations
  cards Card[]

  @@map("rarities")
}

// Set model
model Set {
  id          String    @id @default(cuid())
  name        String    @unique
  code        String    @unique
  releaseDate DateTime
  description String?
  imageUrl    String?

  // Relations
  cards Card[]

  @@map("sets")
}

// Main Card model
model Card {
  id           String   @id @default(cuid())
  name         String
  level        Int?
  cost         Int?
  typeId       String
  rarityId     String
  setId        String
  setNumber    String
  imageUrl     String
  imageUrlSmall String?
  imageUrlLarge String?
  description  String?
  officialText String?
  
  // Official Gundam Card Game attributes
  clashPoints  Int?     // Clash Points (CP) - battle strength
  price        Int?     // Price - cost to play the card
  hitPoints    Int?     // Hit Points (HP) - unit durability (for Unit cards)
  attackPoints Int?     // Attack Points (AP) - damage dealt (for Unit cards)
  faction      String?  // Faction/Group (Earth Federation, Zeon, etc.)
  pilot        String?  // Pilot name for mobile suits
  model        String?  // Mobile suit model number
  series       String?  // Anime series (UC, CE, AD, etc.)
  nation       String?  // Nation/Country affiliation
  
  // Card mechanics
  abilities    String?  // Special abilities (JSON string)
  keywords     String[] // Searchable keywords
  tags         String[] // Categorization tags
  
  // Metadata
  isFoil       Boolean  @default(false)
  isPromo      Boolean  @default(false)
  isAlternate  Boolean  @default(false)
  language     String   @default("en")
  
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  type         CardType @relation(fields: [typeId], references: [id])
  rarity       Rarity   @relation(fields: [rarityId], references: [id])
  set          Set      @relation(fields: [setId], references: [id])
  deckCards    DeckCard[]
  deckVersionCards DeckVersionCard[]
  collectionCards CollectionCard[]
  rulings      CardRuling[]
  submissions  CardSubmission[]

  @@unique([setId, setNumber])
  // Single field indexes for basic searches
  @@index([name])
  @@index([pilot])
  @@index([model])
  @@index([faction])
  @@index([series])
  @@index([nation])
  @@index([keywords])
  @@index([tags])
  @@index([level])
  @@index([cost])
  @@index([clashPoints])
  @@index([price])
  @@index([hitPoints])
  @@index([attackPoints])
  @@index([isFoil])
  @@index([isPromo])
  @@index([isAlternate])
  @@index([language])
  @@index([createdAt])
  @@index([updatedAt])

  // Composite indexes for common filter combinations
  @@index([faction, series])
  @@index([typeId, rarityId])
  @@index([setId, createdAt])
  @@index([level, cost])
  @@index([faction, level])
  @@index([series, faction])
  @@index([name, faction])
  @@index([isFoil, isPromo])

  // Full-text search indexes for text fields
  @@index([name, pilot, model])

  // Performance indexes for sorting
  @@index([name, createdAt])
  @@index([level, name])
  @@index([cost, name])
  @@index([clashPoints, name])
  @@index([createdAt, name])

  @@map("cards")
}

// Deck model
model Deck {
  id          String   @id @default(cuid())
  name        String
  description String?
  isPublic    Boolean  @default(false)
  userId      String

  // Versioning
  currentVersion Int     @default(1)
  versionName    String? // Optional name for the current version

  // Templates and Favorites
  isTemplate     Boolean  @default(false) // Whether this deck can be used as a template
  templateSource String?  // Source attribution for templates ("Official", "Community", etc.)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  user          User                @relation(fields: [userId], references: [id])
  cards         DeckCard[]
  versions      DeckVersion[]
  favoritedBy   UserFavoriteDeck[]  // Users who favorited this deck
  templateUsage DeckTemplateUsage[] // Tracks usage of this deck as template

  @@map("decks")
}

// Deck Version model for revision history
model DeckVersion {
  id          String   @id @default(cuid())
  deckId      String
  version     Int      // Version number (1, 2, 3, etc.)
  name        String   // Deck name at this version
  description String?  // Deck description at this version
  versionName String?  // Optional name for this version ("Initial Build", "Tournament Ready", etc.)
  isPublic    Boolean  @default(false)

  // Version metadata
  changeNote  String?  // Notes about what changed in this version
  createdBy   String   // User who created this version
  createdAt   DateTime @default(now())

  // Snapshot of deck cards at this version
  cards       DeckVersionCard[]

  // Relations
  deck        Deck @relation(fields: [deckId], references: [id], onDelete: Cascade)
  creator     User @relation(fields: [createdBy], references: [id])

  @@unique([deckId, version])
  @@index([deckId, version])
  @@index([deckId, createdAt])
  @@map("deck_versions")
}

// Deck Version Card relationship - snapshot of cards in a specific version
model DeckVersionCard {
  id        String @id @default(cuid())
  versionId String
  cardId    String
  quantity  Int
  category  String?

  // Relations
  version   DeckVersion @relation(fields: [versionId], references: [id], onDelete: Cascade)
  card      Card        @relation(fields: [cardId], references: [id])

  @@unique([versionId, cardId])
  @@map("deck_version_cards")
}

// Deck-Card relationship model
model DeckCard {
  id       String @id @default(cuid())
  deckId   String
  cardId   String
  quantity Int
  category String?

  // Relations
  deck Deck @relation(fields: [deckId], references: [id], onDelete: Cascade)
  card Card @relation(fields: [cardId], references: [id])

  @@unique([deckId, cardId])
  @@map("deck_cards")
}

// Collection model
model Collection {
  id        String   @id @default(cuid())
  userId    String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  user  User             @relation(fields: [userId], references: [id])
  cards CollectionCard[]

  @@unique([userId])
  @@map("collections")
}

// Collection-Card relationship model
model CollectionCard {
  id           String @id @default(cuid())
  collectionId String
  cardId       String
  quantity     Int

  // Relations
  collection Collection @relation(fields: [collectionId], references: [id], onDelete: Cascade)
  card       Card       @relation(fields: [cardId], references: [id])

  @@unique([collectionId, cardId])
  @@map("collection_cards")
}

// Note: Faction and Series models will be added in future iterations
// For now, faction and series are stored as string fields in the Card model

// Card ruling model for official rulings and clarifications
model CardRuling {
  id          String   @id @default(cuid())
  cardId      String
  question    String
  answer      String
  source      String?  // Official source (e.g., "Bandai FAQ")
  isOfficial  Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  card Card @relation(fields: [cardId], references: [id], onDelete: Cascade)

  @@map("card_rulings")
}

// Card submission model for manual uploads (previews, leaks, community submissions)
model CardSubmission {
  id            String   @id @default(cuid())

  // Submission metadata
  submittedBy   String?  // User ID if authenticated, null for anonymous
  submitterName String?  // Display name for anonymous submissions
  submitterEmail String? // Contact email

  // Card data (similar to Card model but as submission)
  name         String
  level        Int?
  cost         Int?
  typeId       String?  // Optional - can be created during approval
  rarityId     String?  // Optional - can be created during approval
  setId        String?  // Optional - can be created during approval
  setName      String?  // Set name for new sets
  setCode      String?  // Set code for new sets
  setNumber    String

  // Image uploads
  imageUrl     String?  // Main card image
  imageFile    String?  // Uploaded file path

  // Card content
  description  String?
  officialText String?
  abilities    String?  // JSON string of abilities

  // Game attributes
  clashPoints  Int?
  price        Int?
  hitPoints    Int?
  attackPoints Int?
  faction      String?
  pilot        String?
  model        String?
  series       String?
  nation       String?
  keywords     String[] @default([])
  tags         String[] @default([])

  // Submission flags
  isFoil       Boolean  @default(false)
  isPromo      Boolean  @default(false)
  isAlternate  Boolean  @default(false)
  isLeak       Boolean  @default(false)    // Leaked card
  isPreview    Boolean  @default(false)    // Official preview
  language     String   @default("en")

  // Approval workflow
  status       SubmissionStatus @default(PENDING)
  priority     SubmissionPriority @default(NORMAL)

  // Review data
  reviewedBy   String?  // Admin user ID who reviewed
  reviewedAt   DateTime?
  reviewNotes  String?  // Admin notes
  rejectionReason String? // Reason for rejection

  // Publication
  publishedCardId String? // ID of created card if approved
  publishedAt     DateTime?

  // Timestamps
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  user         User?    @relation(fields: [submittedBy], references: [id])
  reviewer     User?    @relation("ReviewedSubmissions", fields: [reviewedBy], references: [id])
  publishedCard Card?   @relation(fields: [publishedCardId], references: [id])

  // Single field indexes
  @@index([status])
  @@index([priority])
  @@index([createdAt])
  @@index([submittedBy])
  @@index([reviewedBy])
  @@index([reviewedAt])
  @@index([publishedAt])
  @@index([name])
  @@index([faction])
  @@index([series])
  @@index([isLeak])
  @@index([isPreview])

  // Composite indexes for admin queries
  @@index([status, priority])
  @@index([status, createdAt])
  @@index([priority, createdAt])
  @@index([submittedBy, status])
  @@index([reviewedBy, reviewedAt])

  @@map("card_submissions")
}

enum SubmissionStatus {
  PENDING     // Awaiting review
  APPROVED    // Approved for publication
  REJECTED    // Rejected
  PUBLISHED   // Published as card
  ARCHIVED    // Archived/hidden
}

enum SubmissionPriority {
  LOW         // Low priority
  NORMAL      // Normal priority
  HIGH        // High priority (leaks, official previews)
  URGENT      // Urgent (time-sensitive)
}

// User Favorite Decks - tracks which decks users have marked as favorites
model UserFavoriteDeck {
  id       String @id @default(cuid())
  userId   String
  deckId   String

  createdAt DateTime @default(now())

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  deck Deck @relation(fields: [deckId], references: [id], onDelete: Cascade)

  @@unique([userId, deckId])
  @@index([userId])
  @@index([deckId])
  @@map("user_favorite_decks")
}

// Deck Template Usage - tracks when templates are used to create new decks
model DeckTemplateUsage {
  id           String   @id @default(cuid())
  templateId   String   // The deck that was used as a template
  createdDeckId String? // The new deck created from this template (nullable in case deck is deleted)
  userId       String   // User who used the template

  createdAt    DateTime @default(now())

  // Relations
  template    Deck  @relation(fields: [templateId], references: [id], onDelete: Cascade)
  user        User  @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([templateId])
  @@index([userId])
  @@index([createdAt])
  @@map("deck_template_usage")
}
